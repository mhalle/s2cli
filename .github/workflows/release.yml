name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version and name
        id: info
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "NAME=${{ github.event.repository.name }}" >> $GITHUB_OUTPUT

      - name: Generate version file
        run: |
          # Generate _version.py for runtime version access
          VERSION="${{ steps.info.outputs.VERSION }}"
          VERSION="${VERSION#v}"  # Strip 'v' prefix (v0.11.1 -> 0.11.1)
          # Find the package directory under src/
          PKG_DIR=$(find src -mindepth 1 -maxdepth 1 -type d | head -1)
          printf '%s\n' \
            "# Generated by release workflow from tag v${VERSION}" \
            "__version__ = \"${VERSION}\"" \
            > "${PKG_DIR}/_version.py"
          cat "${PKG_DIR}/_version.py"

      - name: Patch pyproject.toml fallback version
        run: |
          # Update fallback-version to match the release tag
          VERSION="${{ steps.info.outputs.VERSION }}"
          VERSION="${VERSION#v}"
          sed -i "s/^fallback-version = .*/fallback-version = \"${VERSION}\"/" pyproject.toml
          grep fallback-version pyproject.toml

      - name: Create skill zip
        run: |
          # Create zip with repo name as root directory
          # Works as both a skill (directory name matches skill name)
          # and Python package (contains pyproject.toml, src/)
          VERSION="${{ steps.info.outputs.VERSION }}"
          NAME="${{ steps.info.outputs.NAME }}"
          mkdir -p "/tmp/${NAME}"
          rsync -a --exclude='.git' \
                   --exclude='.github' \
                   --exclude='.venv' \
                   --exclude='.pytest_cache' \
                   --exclude='__pycache__' \
                   --exclude='*.pyc' \
                   --exclude='.DS_Store' \
                   --exclude='*.sqlite' \
                   . "/tmp/${NAME}/"
          cd /tmp
          zip -r "$GITHUB_WORKSPACE/${NAME}-${VERSION}.zip" "${NAME}"
          cp "$GITHUB_WORKSPACE/${NAME}-${VERSION}.zip" "$GITHUB_WORKSPACE/${NAME}-${VERSION}.skill"
          cp "$GITHUB_WORKSPACE/${NAME}-${VERSION}.zip" "$GITHUB_WORKSPACE/${NAME}.zip"
          cp "$GITHUB_WORKSPACE/${NAME}-${VERSION}.zip" "$GITHUB_WORKSPACE/${NAME}.skill"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            ${{ steps.info.outputs.NAME }}-${{ steps.info.outputs.VERSION }}.zip
            ${{ steps.info.outputs.NAME }}-${{ steps.info.outputs.VERSION }}.skill
            ${{ steps.info.outputs.NAME }}.zip
            ${{ steps.info.outputs.NAME }}.skill
